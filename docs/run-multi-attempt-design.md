# `run` å‘½ä»¤å¤šè½®è‡ªåŠ¨ä¿®å¤ä¸éªŒè¯è®¾è®¡ç¨¿

## 1. ç›®æ ‡ä¸èŒƒå›´

- **ç›®æ ‡**ï¼šåœ¨ä¸€æ¬¡ `agent-foreman run <steps_dir>` è°ƒç”¨ä¸­ï¼Œå¯¹æ¯ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ JSON æ­¥éª¤å•å…ƒï¼Œæ”¯æŒæœ€å¤š **5 è½®**â€œè‡ªåŠ¨å®ç° â†’ å•å…ƒæµ‹è¯• â†’ verification éªŒè¯ â†’ è¿›åº¦æ›´æ–°â€ï¼Œç›´åˆ°è¯¥æ­¥éª¤é€šè¿‡ä¸ºæ­¢ï¼›å¦‚æœ 5 è½®ä»æ— æ³•é€šè¿‡ï¼Œåˆ™ä¿ç•™ä¸ºå¤±è´¥çŠ¶æ€å¹¶ç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚
- **èŒƒå›´**ï¼š
  - ä»…å½±å“ `src/run.ts` ä¸­ `runStepsDirectory` çš„è¡Œä¸ºï¼›
  - ä¸æ”¹å˜ `analyze` å‘½ä»¤è¾“å‡ºçš„ JSON ç»“æ„ï¼ˆåªæ˜¯å…è®¸æ–°å¢ `unit_test` å­—æ®µï¼‰ï¼›
  - CLI å…¥å£ä¸å‚æ•°å½¢å¼ä¿æŒä¸å˜ï¼ˆ`run <steps_dir>` ä¸ `run <steps_dir> --full-verify`ï¼‰ã€‚

## 2. æ­¥éª¤ JSON ç»“æ„æ‰©å±•

### 2.1 ç°æœ‰ç»“æ„

```ts
export type StepStatus = "ğŸ”´ å¾…å®Œæˆ" | "ğŸŸ¡ è¿›è¡Œä¸­" | "ğŸŸ¢ å·²å®Œæˆ";

export interface StepJson {
  id: string;
  description: string;
  status: StepStatus;
  verification: VerificationItem[];
  // Allow extra fields for forward compatibility
  [key: string]: unknown;
}
```

### 2.2 æ–°å¢å­—æ®µï¼š`unit_test`

```ts
export interface StepUnitTest {
  command: string;      // ç”¨äºè¿è¡Œä¸å½“å‰æ­¥éª¤ç›¸å…³çš„å•å…ƒæµ‹è¯•çš„å‘½ä»¤
  files?: string[];     // æ¶‰åŠçš„æµ‹è¯•æ–‡ä»¶åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
  notes?: string;       // è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰
}

export interface StepJson {
  id: string;
  description: string;
  status: StepStatus;
  verification: VerificationItem[];
  unit_test?: StepUnitTest;
  [key: string]: unknown;
}
```

JSON ç¤ºä¾‹ï¼š

```json
{
  "id": "step-010",
  "description": "â€¦â€¦",
  "status": "ğŸ”´ å¾…å®Œæˆ",
  "verification": [ ... ],
  "unit_test": {
    "command": "npm test -- tests/run-command.test.ts",
    "files": ["tests/run-command.test.ts"],
    "notes": "è¦†ç›– runStepsDirectory çš„ä¸»è¦åœºæ™¯"
  }
}
```

`RunStepEntry` ä¸­åŒæ­¥å¢åŠ ç¼“å­˜å­—æ®µï¼š

```ts
interface RunStepEntry {
  // ç°æœ‰å­—æ®µ...
  unitTest?: StepUnitTest;
}
```

## 3. å®ç°é˜¶æ®µï¼šAI ç”Ÿæˆä»£ç  + å•å…ƒæµ‹è¯• + `unit_test`

### 3.1 Prompt è¦æ±‚ï¼ˆ`buildRunStepPrompt`ï¼‰

åœ¨ç°æœ‰å®ç° prompt ä¸Šæ–°å¢ä¸€æ®µçº¦æŸï¼š

- è¦æ±‚ AI åœ¨å®Œæˆå®ç°ä¸å•å…ƒæµ‹è¯•ç¼–å†™åï¼Œåœ¨è¾“å‡ºæœ«å°¾é™„åŠ ä¸€ä¸ªä»…åŒ…å« `unit_test` å­—æ®µçš„ JSON å¯¹è±¡ï¼š

```json
{
  "unit_test": {
    "command": "npm test -- tests/run-command.test.ts",
    "files": ["tests/run-command.test.ts"],
    "notes": "è¦†ç›– runStepsDirectory çš„ä¸»è¦åœºæ™¯"
  }
}
```

- çº¦æŸï¼š
  - ä¸ä½¿ç”¨ Markdown ä»£ç å—ï¼Œåªè¾“å‡ºè£¸ JSONï¼›
  - å­—æ®µå¿…é¡»ä½¿ç”¨è‹±æ–‡åŒå¼•å·ï¼›
  - å¦‚æœè®¤ä¸ºä¸éœ€è¦/æ— æ³•ç¼–å†™ä¸“é—¨å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥çœç•¥ `unit_test` å­—æ®µï¼ˆä¸è¦è¾“å‡ºç©ºå­—æ®µï¼‰ã€‚

### 3.2 è¾“å‡ºè§£æä¸å†™å› JSON

- æ–°å¢è¾…åŠ©å‡½æ•° `extractUnitTestFromOutput(output: string): StepUnitTest | undefined`ï¼š
  - ä½¿ç”¨ `extractJsonObject` ä» AI è¾“å‡ºä¸­æå– JSONï¼›
  - è§£æ `unit_test.command/files/notes`ï¼Œåšæœ€å°åˆæ³•æ€§æ ¡éªŒã€‚
- åœ¨å®ç°é˜¶æ®µ `callAnyAvailableAgent` è¿”å› `success: true` åï¼š
  - å°è¯•æå– `unit_test` å¹¶å†™å…¥ï¼š
    - `step.unit_test = unitTest;`
    - `entry.unitTest = unitTest;`
  - å°†æ›´æ–°åçš„ `step` å†™å›å¯¹åº”çš„ `NNN-*.json`ã€‚
  - æ§åˆ¶å°è¾“å‡ºæç¤ºï¼š`å•å…ƒæµ‹è¯•ä¿¡æ¯å·²è®°å½•åˆ°æ­¥éª¤ JSONï¼ˆå‘½ä»¤ï¼š<command>ï¼‰`ã€‚

## 4. éªŒè¯é˜¶æ®µï¼š`unit_test` + verificationï¼ˆå•è½®é€»è¾‘ï¼‰

### 4.1 æ™®é€š runï¼ˆä¸å¸¦ `--full-verify`ï¼‰ä¸­çš„å•è½®éªŒè¯

åœ¨æ¯ä¸ªæ­¥éª¤çš„å®ç°é˜¶æ®µæˆåŠŸåï¼Œè¿½åŠ ä¸€è½®ã€Œå•å…ƒæµ‹è¯•ï¼ˆå¦‚æœ‰ï¼‰ + verificationã€ï¼š

1. **æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ `unit_test`ï¼‰**ï¼š
   - è‹¥ `entry.unitTest?.command` å­˜åœ¨ï¼š
     - æ§åˆ¶å°ï¼š`ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•: <command>`ï¼›
     - ä½¿ç”¨ `spawnSync(command, { cwd, shell: true })` æ‰§è¡Œï¼›
     - è‹¥é€€å‡ºç ä¸º 0ï¼šè¾“å‡º `âœ“ å•å…ƒæµ‹è¯•é€šè¿‡`ï¼›
     - è‹¥é€€å‡ºç é 0ï¼š
       - è¾“å‡º `âœ— å•å…ƒæµ‹è¯•å¤±è´¥`ï¼Œæ‰“å°æˆªæ–­åçš„ stderr/stdoutï¼›
       - å°†æ­¥éª¤çŠ¶æ€æ”¹ä¸º `ğŸ”´ å¾…å®Œæˆ`ï¼Œè®°å½• `entry.error = "å•å…ƒæµ‹è¯•å¤±è´¥"`ï¼›
       - å†™å› JSONï¼›
       - é‡å†™ `run-progress.md`ï¼›
       - è®°ä¸º `firstFailure` å¹¶ç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚

2. **æŒ‰ verification è°ƒç”¨ AI éªŒè¯**ï¼š
   - æ„é€  `buildRunStepValidationPrompt`ï¼Œè¯´æ˜è¿™æ˜¯æŒ‰ `verification` åšçš„éªŒè¯ï¼›
   - æ§åˆ¶å°ï¼š`æ­£åœ¨è°ƒç”¨å‘½ä»¤è¡Œ AI æŒ‰ verification è¿›è¡ŒéªŒè¯...`ï¼›
   - è°ƒç”¨ `callAnyAvailableAgent`ï¼š
     - è‹¥ `success: false`ï¼š
       - æ§åˆ¶å°è¾“å‡º `âœ— verification éªŒè¯æœªé€šè¿‡ï¼š<é”™è¯¯>`ï¼›
       - çŠ¶æ€æ”¹ä¸º `ğŸ”´ å¾…å®Œæˆ`ï¼Œè®°å½•é”™è¯¯ï¼›
       - å†™å› JSONï¼›
       - é‡å†™ `run-progress.md`ï¼›
       - è®°ä¸º `firstFailure` å¹¶ç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚
     - è‹¥ `success: true`ï¼š
       - è¾“å‡º `âœ“ verification éªŒè¯é€šè¿‡`ï¼›
       - ä¿æŒçŠ¶æ€ä¸º `ğŸŸ¢ å·²å®Œæˆ`ï¼›
       - é‡å†™ `run-progress.md`ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ­¥éª¤ã€‚

### 4.2 `--full-verify` ä¸‹å·²å®Œæˆæ­¥éª¤çš„å›å½’éªŒè¯

å¯¹ `status === "ğŸŸ¢ å·²å®Œæˆ" && fullVerify` çš„æ­¥éª¤ï¼Œå½“å‰é€»è¾‘ï¼š

1. æ§åˆ¶å°ï¼š`å½“å‰æ­¥éª¤å·²æ ‡è®°ä¸ºå·²å®Œæˆï¼Œå°†ä»…é‡æ–°è¿è¡Œæµ‹è¯•è¿›è¡Œå›å½’éªŒè¯...`ã€‚
2. è‹¥å­˜åœ¨ `unit_test`ï¼š
   - æ‰§è¡Œ `unit_test.command`ï¼›
   - å¤±è´¥åˆ™ï¼š
     - è¾“å‡º `âœ— å•å…ƒæµ‹è¯•å¤±è´¥`ï¼ŒçŠ¶æ€é€»è¾‘ä¿æŒä¸å˜ä½†æ ‡è®° `entry.success = false`ï¼›
     - å†™å…¥ `run-progress.md`ï¼›
     - æ§åˆ¶å°æç¤ºå°†é‡æ–°æ‰“å¼€è¯¥æ­¥éª¤ï¼›
     - `needImplementation = true`ï¼Œå³åç»­ä¼šå¯¹è¯¥æ­¥éª¤è¿›å…¥å®ç°é˜¶æ®µã€‚
3. è‹¥å•æµ‹é€šè¿‡ï¼ˆæˆ–æ—  `unit_test`ï¼‰ï¼Œè°ƒç”¨ AI è¿›è¡Œ verificationï¼š
   - éªŒè¯é€šè¿‡ï¼šä¿æŒ `ğŸŸ¢ å·²å®Œæˆ`ï¼Œå†™å…¥ `run-progress.md`ï¼Œè·³è¿‡å®ç°é˜¶æ®µï¼›
   - éªŒè¯å¤±è´¥ï¼šæç¤ºå¤±è´¥åŸå› ï¼Œå¹¶å°† `needImplementation = true`ï¼Œè¿›å…¥å®ç°é˜¶æ®µã€‚

## 5. å¤šè½®è‡ªåŠ¨ä¿®å¤è®¾è®¡ï¼ˆå¾…å®ç°ï¼‰

> æœ¬èŠ‚æ˜¯ä¸‹ä¸€æ­¥è¦æ”¹çš„é€»è¾‘ï¼Œå°šæœªè½å…¥ä»£ç ã€‚

ç›®æ ‡ï¼šå¯¹æ¯ä¸ªéœ€è¦å®ç°çš„æ­¥éª¤ï¼ˆæ™®é€š run åœºæ™¯ï¼‰ï¼Œæ”¯æŒæœ€å¤š **5 è½®**è‡ªåŠ¨ä¿®å¤å°è¯•ï¼š

- å¤–å±‚åœ¨ `runStepsDirectory` çš„å•ä¸ªæ­¥éª¤é€»è¾‘ä¸­å¼•å…¥ï¼š

```ts
const MAX_ATTEMPTS = 5;

for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
  // 1. å®ç°é˜¶æ®µï¼ˆå¸¦ä¸Šä¸‹æ–‡çš„ promptï¼‰
  // 2. å†™å› unit_test + JSON
  // 3. æ‰§è¡Œ unit_testï¼ˆå¦‚æœ‰ï¼‰
  // 4. æŒ‰ verification éªŒè¯
  // 5. æ ¹æ®ç»“æœå†³å®š break æˆ–ç»§ç»­ä¸‹ä¸€è½®
}
```

- ç¬¬ 1 è½®ï¼š
  - ä½¿ç”¨å½“å‰çš„ `buildRunStepPrompt`ï¼ˆæ— é¢å¤–é”™è¯¯ä¸Šä¸‹æ–‡ï¼‰ã€‚

- ç¬¬ 2ï½5 è½®ï¼š
  - åœ¨å®ç° prompt ä¸­è¿½åŠ ã€Œä¸Šä¸€è½®å¤±è´¥åŸå› æ‘˜è¦ã€ï¼š
    - å•å…ƒæµ‹è¯•å‘½ä»¤ + æˆªæ–­åçš„ stdout/stderrï¼›
    - verification é”™è¯¯ä¿¡æ¯ï¼›
    - å½“å‰æ­¥éª¤çš„çŠ¶æ€ä¸å‰ä¸€æ¬¡ä¿®æ”¹çš„ç®€è¦è¯´æ˜ã€‚
  - æœŸæœ› AI åœ¨ç†è§£å¤±è´¥åŸå› çš„å‰æä¸‹è¿›è¡Œé’ˆå¯¹æ€§ä¿®å¤ã€‚

- æ¯ä¸€è½®ç»“æŸåçš„è¡Œä¸ºï¼š
  - å¦‚æœå•æµ‹ + verification å…¨éƒ¨é€šè¿‡ï¼š
    - çŠ¶æ€è®¾ä¸º `ğŸŸ¢ å·²å®Œæˆ`ï¼Œå†™å› JSONï¼›
    - é‡å†™ `run-progress.md`ï¼Œå¹¶è·³å‡ºå¾ªç¯ï¼›
  - å¦‚æœå¤±è´¥ï¼š
    - çŠ¶æ€è®¾ä¸º `ğŸ”´ å¾…å®Œæˆ`ï¼›
    - å†™å› JSONã€é‡å†™ `run-progress.md`ï¼›
    - è‹¥ `attempt < MAX_ATTEMPTS`ï¼šç»§ç»­ä¸‹ä¸€è½®ï¼›
    - è‹¥ `attempt === MAX_ATTEMPTS`ï¼šè®°å½• `firstFailure`ï¼Œç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚

- æ§åˆ¶å°è¾“å‡ºå»ºè®®ï¼š
  - æ¯è½®å¼€å¤´æ‰“å°ï¼š`ğŸ” ç¬¬ N/5 æ¬¡å°è¯•æ‰§è¡Œè¯¥æ­¥éª¤...`ï¼›
  - åœ¨å¤±è´¥æ—¶æ‰“å°ç®€çŸ­æ‘˜è¦ï¼ˆåŒ¹é…å†™å…¥ prompt çš„å¤±è´¥åŸå› ï¼‰ï¼›
  - åœ¨æœ€ç»ˆé€šè¿‡æ—¶æ‰“å°ï¼š`âœ“ ç¬¬ N æ¬¡å°è¯•åæ­¥éª¤å·²é€šè¿‡æ‰€æœ‰æµ‹è¯•ä¸éªŒè¯`ã€‚

## 6. è¿›åº¦æŠ¥å‘Šä¸ç”¨æˆ·ä½“éªŒ

- `run-progress.md`ï¼š
  - æ–‡ä»¶åå›ºå®šä¸º `run-progress.md`ï¼Œä½äºæ­¥éª¤ç›®å½•ï¼›
  - åœ¨ä»¥ä¸‹æ—¶æœºé‡å†™ï¼š
    - è§£æ JSON å¤±è´¥æ—¶ï¼ˆå¼€å¤´å°±ç»ˆæ­¢ï¼‰ï¼›
    - æ¯è½®å®ç°é˜¶æ®µå‡ºç°å†™å…¥é”™è¯¯ï¼›
    - æ¯è½®å•å…ƒæµ‹è¯•å¤±è´¥ï¼›
    - æ¯è½® verification å¤±è´¥ï¼›
    - æ¯è½®éªŒè¯æˆåŠŸåï¼ˆåŒ…æ‹¬ full-verify åœºæ™¯ï¼‰ã€‚
- æ§åˆ¶å°ï¼š
  - æ¯ä¸ªæ­¥éª¤çš„æ¯ä¸€è½®å°è¯•éƒ½ä¼šæ‰“å°ï¼š
    - å½“å‰è½®æ¬¡ï¼ˆè®¡åˆ’å®ç°åï¼‰ï¼›
    - çŠ¶æ€å˜æ›´ï¼ˆğŸ”´/ğŸŸ¡/ğŸŸ¢ï¼‰ï¼›
    - å•æµ‹å‘½ä»¤ä¸ç»“æœï¼›
    - verification éªŒè¯ç»“æœï¼›
    - å½“æ¬¡ run çš„æ±‡æ€»ç»Ÿè®¡ã€‚

