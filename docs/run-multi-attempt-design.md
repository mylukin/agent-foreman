# `run` å‘½ä»¤å¤šè½®è‡ªåŠ¨ä¿®å¤ä¸éªŒè¯è®¾è®¡ç¨¿

## 1. ç›®æ ‡ä¸èŒƒå›´

- **ç›®æ ‡**ï¼šåœ¨ä¸€æ¬¡ `agent-foreman run <steps_dir>` è°ƒç”¨ä¸­ï¼Œå¯¹æ¯ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ JSON æ­¥éª¤å•å…ƒï¼Œæ”¯æŒæœ€å¤š **5 è½®**â€œè‡ªåŠ¨å®ç° â†’ å•å…ƒæµ‹è¯• â†’ verification éªŒè¯ â†’ è¿›åº¦æ›´æ–°â€ï¼Œç›´åˆ°è¯¥æ­¥éª¤é€šè¿‡ä¸ºæ­¢ï¼›å¦‚æœ 5 è½®ä»æ— æ³•é€šè¿‡ï¼Œåˆ™ä¿ç•™ä¸ºå¤±è´¥çŠ¶æ€å¹¶ç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚
- **èŒƒå›´**ï¼š
  - ä»…å½±å“ `src/run.ts` ä¸­ `runStepsDirectory` çš„è¡Œä¸ºï¼›
  - ä¸æ”¹å˜ `analyze` å‘½ä»¤è¾“å‡ºçš„ JSON ç»“æ„ï¼ˆåªæ˜¯å…è®¸æ–°å¢ `unit_test` å­—æ®µï¼‰ï¼›
  - CLI å…¥å£ä¸å‚æ•°å½¢å¼åŸºäº `run <steps_dir>` æ‰©å±•äº†å¤šç§éªŒè¯æ¨¡å¼ï¼š
    - é»˜è®¤æ¨¡å¼ï¼š`run <steps_dir>`ï¼Œæ‰§è¡Œã€Œå®ç° + å•å…ƒæµ‹è¯• + verificationã€å¹¶æ”¯æŒæœ€å¤š 5 è½®è‡ªåŠ¨ä¿®å¤ï¼›
    - å®ç°ä¸“ç”¨æ¨¡å¼ï¼š`run <steps_dir> --no-test`ï¼Œåªåšå®ç°ï¼Œä¸ç”Ÿæˆ/è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œä¹Ÿä¸åš verification éªŒè¯ï¼›
    - å›å½’éªŒè¯æ¨¡å¼ï¼š`run <steps_dir> --full-verify`ï¼Œå¯¹å·²å®Œæˆæ­¥éª¤é¢å¤–è¿è¡Œå•æµ‹å’Œ verificationï¼Œå‘ç°é—®é¢˜æ—¶é‡æ–°æ‰“å¼€å¹¶è¿›å…¥å¤šè½®å®ç°ï¼›
    - ä»…éªŒè¯æ¨¡å¼ï¼š`run <steps_dir> --verify-only`ï¼Œåªè¿è¡Œå•å…ƒæµ‹è¯•å’Œ verificationï¼Œä¸åšä»»ä½•å®ç°æ”¹åŠ¨ï¼›
    - ä»…å•å…ƒæµ‹è¯•æ¨¡å¼ï¼š`run <steps_dir> --verify-unittest-only`ï¼Œåªè¿è¡Œ `unit_test` ä¸­å®šä¹‰çš„å•å…ƒæµ‹è¯•ï¼Œä¸è°ƒç”¨ AIï¼Œä¹Ÿä¸åšå®ç°æ”¹åŠ¨ï¼›
    - å•æµ‹è¡¥å…¨æ¨¡å¼ï¼š`run <steps_dir> --verify-generate-unittest`ï¼Œåªä¸ºç¼ºå°‘ `unit_test` é…ç½®çš„æ­¥éª¤ç”Ÿæˆå•å…ƒæµ‹è¯•ä¿¡æ¯å¹¶å†™å› JSONï¼Œä¸æ”¹åŠ¨ä¸šåŠ¡å®ç°ã€‚

åœ¨æœ¬ä»“åº“ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿é’ˆå¯¹æœ¬ PRD è¿›è¡Œå¼€å‘ä¸å›å½’éªŒè¯ï¼Œ`makefile` ä¸­æä¾›äº†ä¸ä¸Šè¿°æ¨¡å¼ä¸€ä¸€å¯¹åº”çš„è¾…åŠ©å‘½ä»¤ï¼ˆä»¥æœ¬è®¾è®¡æ–‡æ¡£ä½œä¸ºè¾“å…¥ï¼‰ï¼š

```make
PRD=./docs/run-multi-attempt-design.md
STEPS="run å‘½ä»¤å¤šè½®è‡ªåŠ¨ä¿®å¤ä¸éªŒè¯éœ€æ±‚å®ç°æ­¥éª¤"

run_analyze:
	npm run dev -- analyze $(PRD)

run_run:
	npm run dev -- run "${STEPS}"

run_run_verify:
	npm run dev -- run "${STEPS}" --full-verify

run_run_verify_only:
	npm run dev -- run "${STEPS}" --verify-only

run_run_verify_unittest_only:
	npm run dev -- run "${STEPS}" --verify-unittest-only

run_run_verify_generate_unittest:
	npm run dev -- run "${STEPS}" --verify-generate-unittest
```

å¯¹åº”å…³ç³»æ€»ç»“ï¼š

- `make run_analyze`ï¼šå¯¹æœ¬ PRD æ–‡æ¡£æ‰§è¡Œ `analyze`ï¼Œç”Ÿæˆã€Œ`run å‘½ä»¤å¤šè½®è‡ªåŠ¨ä¿®å¤ä¸éªŒè¯éœ€æ±‚å®ç°æ­¥éª¤`ã€ç›®å½•ï¼›
- `make run_run`ï¼šåœ¨é»˜è®¤æ¨¡å¼ä¸‹å¯¹ä¸Šè¿°æ­¥éª¤ç›®å½•æ‰§è¡Œ `run`ï¼›
- `make run_run_verify`ï¼šç­‰ä»·äº `run <steps_dir> --full-verify`ï¼Œåšå›å½’éªŒè¯ï¼›
- `make run_run_verify_only`ï¼šç­‰ä»·äº `run <steps_dir> --verify-only`ï¼Œä»…åšï¼ˆå•æµ‹ + verificationï¼‰éªŒè¯ï¼›
- `make run_run_verify_unittest_only`ï¼šç­‰ä»·äº `run <steps_dir> --verify-unittest-only`ï¼Œä»…è·‘å•å…ƒæµ‹è¯•ï¼›
- `make run_run_verify_generate_unittest`ï¼šç­‰ä»·äº `run <steps_dir> --verify-generate-unittest`ï¼Œä¸ºç¼ºå°‘å•æµ‹é…ç½®çš„æ­¥éª¤è¡¥é½ `unit_test`ã€‚

## 2. æ­¥éª¤ JSON ç»“æ„æ‰©å±•

### 2.1 ç°æœ‰ç»“æ„

```ts
export type StepStatus = "ğŸ”´ å¾…å®Œæˆ" | "ğŸŸ¡ è¿›è¡Œä¸­" | "ğŸŸ¢ å·²å®Œæˆ";

export interface StepJson {
  id: string;
  description: string;
  status: StepStatus;
  verification: VerificationItem[];
  // Allow extra fields for forward compatibility
  [key: string]: unknown;
}
```

### 2.2 æ–°å¢å­—æ®µï¼š`unit_test`

```ts
export interface StepUnitTest {
  command: string;      // ç”¨äºè¿è¡Œä¸å½“å‰æ­¥éª¤ç›¸å…³çš„å•å…ƒæµ‹è¯•çš„å‘½ä»¤
  files?: string[];     // æ¶‰åŠçš„æµ‹è¯•æ–‡ä»¶åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
  notes?: string;       // è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰
}

export interface StepJson {
  id: string;
  description: string;
  status: StepStatus;
  verification: VerificationItem[];
  unit_test?: StepUnitTest;
  [key: string]: unknown;
}
```

JSON ç¤ºä¾‹ï¼š

```json
{
  "id": "step-010",
  "description": "â€¦â€¦",
  "status": "ğŸ”´ å¾…å®Œæˆ",
  "verification": [ ... ],
  "unit_test": {
    "command": "npm test -- tests/run-command.test.ts",
    "files": ["tests/run-command.test.ts"],
    "notes": "è¦†ç›– runStepsDirectory çš„ä¸»è¦åœºæ™¯"
  }
}
```

`RunStepEntry` ä¸­åŒæ­¥å¢åŠ ç¼“å­˜å­—æ®µï¼š

```ts
interface RunStepEntry {
  // ç°æœ‰å­—æ®µ...
  unitTest?: StepUnitTest;
}
```

## 3. å®ç°é˜¶æ®µï¼šAI ç”Ÿæˆä»£ç  + å•å…ƒæµ‹è¯• + `unit_test`

### 3.1 Prompt è¦æ±‚ï¼ˆ`buildRunStepPrompt`ï¼‰

åœ¨ç°æœ‰å®ç° prompt ä¸Šæ–°å¢ä¸€æ®µçº¦æŸï¼š

- è¦æ±‚ AI åœ¨å®Œæˆå®ç°ä¸å•å…ƒæµ‹è¯•ç¼–å†™åï¼Œåœ¨è¾“å‡ºæœ«å°¾é™„åŠ ä¸€ä¸ªä»…åŒ…å« `unit_test` å­—æ®µçš„ JSON å¯¹è±¡ï¼š

```json
{
  "unit_test": {
    "command": "npm test -- tests/run-command.test.ts",
    "files": ["tests/run-command.test.ts"],
    "notes": "è¦†ç›– runStepsDirectory çš„ä¸»è¦åœºæ™¯"
  }
}
```

- çº¦æŸï¼š
  - ä¸ä½¿ç”¨ Markdown ä»£ç å—ï¼Œåªè¾“å‡ºè£¸ JSONï¼›
  - å­—æ®µå¿…é¡»ä½¿ç”¨è‹±æ–‡åŒå¼•å·ï¼›
  - å¦‚æœè®¤ä¸ºä¸éœ€è¦/æ— æ³•ç¼–å†™ä¸“é—¨å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥çœç•¥ `unit_test` å­—æ®µï¼ˆä¸è¦è¾“å‡ºç©ºå­—æ®µï¼‰ã€‚

### 3.2 è¾“å‡ºè§£æä¸å†™å› JSON

- æ–°å¢è¾…åŠ©å‡½æ•° `extractUnitTestFromOutput(output: string): StepUnitTest | undefined`ï¼š
  - ä½¿ç”¨ `extractJsonObject` ä» AI è¾“å‡ºä¸­æå– JSONï¼›
  - è§£æ `unit_test.command/files/notes`ï¼Œåšæœ€å°åˆæ³•æ€§æ ¡éªŒã€‚
- åœ¨å®ç°é˜¶æ®µ `callAnyAvailableAgent` è¿”å› `success: true` åï¼š
  - å°è¯•æå– `unit_test` å¹¶å†™å…¥ï¼š
    - `step.unit_test = unitTest;`
    - `entry.unitTest = unitTest;`
  - å°†æ›´æ–°åçš„ `step` å†™å›å¯¹åº”çš„ `NNN-*.json`ã€‚
  - æ§åˆ¶å°è¾“å‡ºæç¤ºï¼š`å•å…ƒæµ‹è¯•ä¿¡æ¯å·²è®°å½•åˆ°æ­¥éª¤ JSONï¼ˆå‘½ä»¤ï¼š<command>ï¼‰`ã€‚

## 4. éªŒè¯é˜¶æ®µï¼š`unit_test` + verificationï¼ˆå•è½®é€»è¾‘ï¼‰

### 4.1 æ™®é€š runï¼ˆä¸å¸¦ `--full-verify`ï¼‰ä¸­çš„å•è½®éªŒè¯

åœ¨æ¯ä¸ªæ­¥éª¤çš„å®ç°é˜¶æ®µæˆåŠŸåï¼Œè¿½åŠ ä¸€è½®ã€Œå•å…ƒæµ‹è¯•ï¼ˆå¦‚æœ‰ï¼‰ + verificationã€ï¼š

1. **æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ `unit_test`ï¼‰**ï¼š
   - è‹¥ `entry.unitTest?.command` å­˜åœ¨ï¼š
     - æ§åˆ¶å°ï¼š`ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•: <command>`ï¼›
     - ä½¿ç”¨ `spawnSync(command, { cwd, shell: true })` æ‰§è¡Œï¼›
     - è‹¥é€€å‡ºç ä¸º 0ï¼šè¾“å‡º `âœ“ å•å…ƒæµ‹è¯•é€šè¿‡`ï¼›
     - è‹¥é€€å‡ºç é 0ï¼š
       - è¾“å‡º `âœ— å•å…ƒæµ‹è¯•å¤±è´¥`ï¼Œæ‰“å°æˆªæ–­åçš„ stderr/stdoutï¼›
       - å°†æ­¥éª¤çŠ¶æ€æ”¹ä¸º `ğŸ”´ å¾…å®Œæˆ`ï¼Œè®°å½• `entry.error = "å•å…ƒæµ‹è¯•å¤±è´¥"`ï¼›
       - å†™å› JSONï¼›
       - é‡å†™ `run-progress.md`ï¼›
       - è®°ä¸º `firstFailure` å¹¶ç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚

2. **æŒ‰ verification è°ƒç”¨ AI éªŒè¯**ï¼š
   - æ„é€  `buildRunStepValidationPrompt`ï¼Œè¯´æ˜è¿™æ˜¯æŒ‰ `verification` åšçš„éªŒè¯ï¼›
   - æ§åˆ¶å°ï¼š`æ­£åœ¨è°ƒç”¨å‘½ä»¤è¡Œ AI æŒ‰ verification è¿›è¡ŒéªŒè¯...`ï¼›
   - è°ƒç”¨ `callAnyAvailableAgent`ï¼š
     - è‹¥ `success: false`ï¼š
       - æ§åˆ¶å°è¾“å‡º `âœ— verification éªŒè¯æœªé€šè¿‡ï¼š<é”™è¯¯>`ï¼›
       - çŠ¶æ€æ”¹ä¸º `ğŸ”´ å¾…å®Œæˆ`ï¼Œè®°å½•é”™è¯¯ï¼›
       - å†™å› JSONï¼›
       - é‡å†™ `run-progress.md`ï¼›
       - è®°ä¸º `firstFailure` å¹¶ç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚
     - è‹¥ `success: true`ï¼š
       - è¾“å‡º `âœ“ verification éªŒè¯é€šè¿‡`ï¼›
       - ä¿æŒçŠ¶æ€ä¸º `ğŸŸ¢ å·²å®Œæˆ`ï¼›
       - é‡å†™ `run-progress.md`ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ­¥éª¤ã€‚

### 4.2 `--full-verify` ä¸‹å·²å®Œæˆæ­¥éª¤çš„å›å½’éªŒè¯

å¯¹ `status === "ğŸŸ¢ å·²å®Œæˆ" && fullVerify` çš„æ­¥éª¤ï¼Œå½“å‰é€»è¾‘ï¼š

1. æ§åˆ¶å°ï¼š`å½“å‰æ­¥éª¤å·²æ ‡è®°ä¸ºå·²å®Œæˆï¼Œå°†ä»…é‡æ–°è¿è¡Œæµ‹è¯•è¿›è¡Œå›å½’éªŒè¯...`ã€‚
2. è‹¥å­˜åœ¨ `unit_test`ï¼š
   - æ‰§è¡Œ `unit_test.command`ï¼›
   - å¤±è´¥åˆ™ï¼š
     - è¾“å‡º `âœ— å•å…ƒæµ‹è¯•å¤±è´¥`ï¼ŒçŠ¶æ€é€»è¾‘ä¿æŒä¸å˜ä½†æ ‡è®° `entry.success = false`ï¼›
     - å†™å…¥ `run-progress.md`ï¼›
     - æ§åˆ¶å°æç¤ºå°†é‡æ–°æ‰“å¼€è¯¥æ­¥éª¤ï¼›
     - `needImplementation = true`ï¼Œå³åç»­ä¼šå¯¹è¯¥æ­¥éª¤è¿›å…¥å®ç°é˜¶æ®µã€‚
3. è‹¥å•æµ‹é€šè¿‡ï¼ˆæˆ–æ—  `unit_test`ï¼‰ï¼Œè°ƒç”¨ AI è¿›è¡Œ verificationï¼š
   - éªŒè¯é€šè¿‡ï¼šä¿æŒ `ğŸŸ¢ å·²å®Œæˆ`ï¼Œå†™å…¥ `run-progress.md`ï¼Œè·³è¿‡å®ç°é˜¶æ®µï¼›
   - éªŒè¯å¤±è´¥ï¼šæç¤ºå¤±è´¥åŸå› ï¼Œå¹¶å°† `needImplementation = true`ï¼Œè¿›å…¥å®ç°é˜¶æ®µã€‚

## 5. å¤šè½®è‡ªåŠ¨ä¿®å¤å®ç°ç»†èŠ‚

æœ¬èŠ‚æè¿° **å·²ç»è½åœ°åœ¨ `src/run.ts` ä¸­çš„å®é™…è¡Œä¸º**ï¼Œå¯¹åº”å¸¸é‡ï¼š

```ts
const MAX_ATTEMPTS = 5;
```

### 5.1 é€‚ç”¨èŒƒå›´ä¸å…¥å£

- å¤šè½®è‡ªåŠ¨ä¿®å¤åªå¯¹ã€Œéœ€è¦å®ç°ã€çš„æ­¥éª¤ç”Ÿæ•ˆï¼Œå³ï¼š
  - æ™®é€š `run <steps_dir>` åœºæ™¯ä¸‹ï¼Œ`status !== "ğŸŸ¢ å·²å®Œæˆ"` çš„æ­¥éª¤ï¼›
  - `run <steps_dir> --full-verify` åœºæ™¯ä¸‹ï¼Œè‹¥å·²å®Œæˆæ­¥éª¤åœ¨å›å½’æµ‹è¯•/éªŒè¯é˜¶æ®µå¤±è´¥ï¼Œè¢«é‡æ–°æ‰“å¼€åï¼ˆ`needImplementation = true`ï¼‰ä¹Ÿä¼šè¿›å…¥åŒä¸€å¥—å¤šè½®é€»è¾‘ã€‚
- å¯¹äº `status === "ğŸŸ¢ å·²å®Œæˆ"` ä¸”åœ¨ `--full-verify` ä¸‹å›å½’æµ‹è¯•ä¸ verification å‡é€šè¿‡çš„æ­¥éª¤ï¼Œåˆ™åªåšä¸€æ¬¡ã€Œæµ‹è¯• + éªŒè¯ã€ï¼Œä¸ä¼šè¿›å…¥å¤šè½®å®ç°æµç¨‹ï¼ˆè§ç¬¬ 4.2 èŠ‚ï¼‰ã€‚

åœ¨ `runStepsDirectory` ä¸­ï¼Œå¯¹æ¯ä¸ªéœ€è¦å®ç°çš„æ­¥éª¤éƒ½ä¼šæ‰§è¡Œï¼š

```ts
for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
  // 1. æ ‡è®°ä¸ºè¿›è¡Œä¸­å¹¶å†™å› JSON
  // 2. æ„é€ å®ç° promptï¼ˆå¿…è¦æ—¶é™„å¸¦ä¸Šä¸€è½®å¤±è´¥æ‘˜è¦ï¼‰
  // 3. è°ƒç”¨ AI å®ç°æœ¬è½®ä¿®æ”¹
  // 4. åœ¨æ™®é€š run æ¨¡å¼ä¸‹æ‰§è¡Œå•å…ƒæµ‹è¯•å’Œ verification
  // 5. æ ¹æ®ç»“æœå†³å®šç»“æŸæˆ–è¿›å…¥ä¸‹ä¸€è½®
}
```

### 5.2 æ¯è½®å¼€å§‹ï¼šçŠ¶æ€æ›´æ–°ä¸æ—¥å¿—

æ¯ä¸€è½®å°è¯•å¼€å§‹æ—¶ï¼š

1. è®°å½•æœ¬è½®å¼€å§‹å‰çš„çŠ¶æ€ `attemptStartStatus`ï¼›
2. å°†æ­¥éª¤çŠ¶æ€æ›´æ–°ä¸º `ğŸŸ¡ è¿›è¡Œä¸­`ï¼Œå†™å›å¯¹åº”çš„ `NNN-*.json` æ–‡ä»¶ï¼›
   - å¦‚æœå†™å›å¤±è´¥ï¼Œä¼šç«‹å³å†™å…¥ä¸€æ¬¡ `run-progress.md` å¹¶ç»ˆæ­¢æœ¬æ¬¡ `run`ï¼›
3. æ§åˆ¶å°æ‰“å°çŠ¶æ€è¿ç§»ï¼Œä¾‹å¦‚ï¼š

   ```text
   çŠ¶æ€æ›´æ–°: ğŸ”´ å¾…å®Œæˆ â†’ ğŸŸ¡ è¿›è¡Œä¸­
   ğŸ” [1/3] ç¬¬ 1/5 æ¬¡å°è¯•æ‰§è¡Œè¯¥æ­¥éª¤ï¼ˆé¦–æ¬¡å°è¯•ï¼‰...
   ```

   - é¦–è½®å°è¯•ä¼šæ ‡è®°ä¸ºã€Œé¦–æ¬¡å°è¯•ã€ï¼›
   - åç»­å°è¯•ä¼šè¯´æ˜æ˜¯åŸºäºä¸Šä¸€è½®å¤±è´¥åŸå› è¿›è¡Œä¿®å¤ã€‚

### 5.3 Prompt ç»“æ„ä¸å¤±è´¥ä¸Šä¸‹æ–‡

- æ¯ä¸€è½®éƒ½ä¼šåŸºäºå½“å‰æ­¥éª¤çŠ¶æ€æ„é€  `buildRunStepPrompt`ï¼Œå…¶ä¸»ä½“å†…å®¹ä¸ç¬¬ 3 èŠ‚ä¸€è‡´ï¼ˆåŒ…å« `unit_test` è¾“å‡ºçº¦å®šï¼‰ã€‚
- ä»ç¬¬ 2 è½®å¼€å§‹ï¼Œå¦‚æœä¸Šä¸€è½®å¤±è´¥ä¸”æ”¶é›†åˆ°äº†å¤±è´¥ä¸Šä¸‹æ–‡ï¼Œåˆ™ä¼šé€šè¿‡ `appendPreviousFailureContextToPrompt` å°†æ‘˜è¦è¿½åŠ åˆ° prompt æœ«å°¾ã€‚

`PreviousAttemptFailureContext` çš„æ¥æºï¼š

- å½“æŸè½® **å•å…ƒæµ‹è¯•å¤±è´¥** æ—¶ï¼š
  - è®°å½• `unitTestCommand`ï¼›
  - é€šè¿‡ `buildOutputSnippet` æˆªæ–­å¹¶ä¿å­˜æœ€è¿‘ä¸€æ¬¡å•æµ‹å‘½ä»¤çš„æ ‡å‡†è¾“å‡º/é”™è¯¯ä¸º `unitTestOutputSnippet`ï¼›
  - è®¾ç½® `fromStatus` ä¸ºæœ¬è½®å¼€å§‹å‰çŠ¶æ€ï¼Œ`toStatus` ä¸ºå¤±è´¥åçŠ¶æ€ï¼ˆé€šå¸¸æ˜¯ `ğŸ”´ å¾…å®Œæˆ`ï¼‰ã€‚
- å½“æŸè½® **verification å¤±è´¥** æ—¶ï¼š
  - è®°å½• `verificationError` æ–‡æœ¬ï¼ˆæ¥è‡ªéªŒè¯é˜¶æ®µçš„é”™è¯¯ä¿¡æ¯ï¼‰ã€‚
- å½“æŸè½® **AI å®ç°é˜¶æ®µå¤±è´¥** æ—¶ï¼ˆ`callAnyAvailableAgent` è¿”å› `success: false`ï¼‰ï¼š
  - è®°å½• `aiError` æ–‡æœ¬ã€‚

åœ¨ä¸‹ä¸€è½®å°è¯•ä¸­ï¼Œè¿™äº›ä¿¡æ¯ä¼šä»¥ã€Œä¸Šä¸€è½®å°è¯•å¤±è´¥åŸå› æ‘˜è¦ã€çš„å½¢å¼æ‹¼æ¥åˆ° prompt ä¸­ï¼ŒåŒæ—¶æ§åˆ¶å°ä¹Ÿé€šè¿‡ `logAttemptFailureSummary` æ‰“å°å¯¹åº”çš„ç®€è¦è¯´æ˜ï¼Œå¸®åŠ©ä¸‹æ¸¸ AI æœ‰é’ˆå¯¹æ€§åœ°ä¿®å¤ã€‚

### 5.4 å®ç°é˜¶æ®µä¸ `unit_test` å†™å›

å½“æŸè½®å®ç°è°ƒç”¨ `callAnyAvailableAgent` è¿”å› `success: true` æ—¶ï¼š

1. æ­¥éª¤çŠ¶æ€è¢«è®¾ç½®ä¸º `ğŸŸ¢ å·²å®Œæˆ`ï¼Œå¹¶å†™å›å¯¹åº”çš„ JSON æ–‡ä»¶ï¼›
2. ä½¿ç”¨ `extractUnitTestFromOutput(result.output)` ä»æœ¬è½® AI è¾“å‡ºä¸­æå– `unit_test` é…ç½®ï¼š
   - è‹¥æˆåŠŸè§£æå‡ºåˆæ³•çš„ `unit_test`ï¼š
     - å†™å›åˆ°æ­¥éª¤ JSON çš„ `unit_test` å­—æ®µï¼›
     - åŒæ­¥ç¼“å­˜åˆ°å†…å­˜ä¸­çš„ `entry.unitTest`ï¼›
     - æ§åˆ¶å°è¾“å‡ºç±»ä¼¼ï¼š`å•å…ƒæµ‹è¯•ä¿¡æ¯å·²è®°å½•åˆ°æ­¥éª¤ JSONï¼ˆå‘½ä»¤ï¼š<command>ï¼‰`ã€‚
3. å¦‚æœå†™å› JSON å¤±è´¥ï¼ˆä¾‹å¦‚ç£ç›˜é”™è¯¯ï¼‰ï¼Œåˆ™ï¼š
   - æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼›
   - å†™å…¥ `run-progress.md`ï¼›
   - æ ‡è®°å½“å‰æ­¥éª¤ä¸ºå¤±è´¥å¹¶ç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚

æ­¤æ—¶å°šæœªè¿›å…¥æœ¬è½®çš„ã€Œå•å…ƒæµ‹è¯• + verificationã€é˜¶æ®µï¼Œä»ç„¶å¯ä»¥åœ¨å¤±è´¥æ—¶é€šè¿‡åç»­çš„å¤šè½®å°è¯•è¿›è¡Œè‡ªåŠ¨ä¿®å¤ã€‚

### 5.5 å•å…ƒæµ‹è¯•ä¸ verification åœ¨å¤šè½®ä¸­çš„è¡Œä¸º

åœ¨æ™®é€š `run` æ¨¡å¼ï¼ˆæœªå¼€å¯ `--full-verify`ï¼‰ä¸‹ï¼Œæ¯ä¸€è½®æˆåŠŸå®ç°åä¼šæŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡ŒéªŒè¯é€»è¾‘ï¼š

1. **æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼ˆå¦‚å­˜åœ¨ `unit_test`ï¼‰**ï¼š
   - è‹¥ `entry.unitTest?.command` å­˜åœ¨ï¼š
     - æ§åˆ¶å°ï¼š`ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•: <command>`ï¼›
     - ä½¿ç”¨ `runUnitTestsForStep`ï¼ˆå†…éƒ¨åŸºäº `spawnSync`ï¼‰æ‰§è¡Œå‘½ä»¤ï¼›
     - è‹¥é€€å‡ºç ä¸º 0ï¼šè¾“å‡º `âœ“ å•å…ƒæµ‹è¯•é€šè¿‡`ï¼Œç»§ç»­è¿›å…¥ verificationï¼›
     - è‹¥é€€å‡ºç é 0ï¼š
       - è¾“å‡º `âœ— å•å…ƒæµ‹è¯•å¤±è´¥` å¹¶æ‰“å°æˆªæ–­åçš„è¾“å‡ºï¼›
       - å°†æ­¥éª¤çŠ¶æ€æ”¹å› `ğŸ”´ å¾…å®Œæˆ`ï¼Œ`entry.error = "å•å…ƒæµ‹è¯•å¤±è´¥"`ï¼›
       - å¡«å……ä¸Šä¸€è½®å¤±è´¥ä¸Šä¸‹æ–‡ï¼ˆ`unitTestCommand` + `unitTestOutputSnippet`ï¼‰ï¼›
       - å†™å› JSONï¼Œå¹¶é‡å†™ `run-progress.md`ï¼›
       - è‹¥ `attempt < MAX_ATTEMPTS`ï¼šè¿›å…¥ä¸‹ä¸€è½®å°è¯•ï¼›
       - è‹¥ `attempt === MAX_ATTEMPTS`ï¼šè®°å½• `firstFailure`ï¼Œç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚

2. **æŒ‰ verification è°ƒç”¨ AI éªŒè¯**ï¼š
   - æ„é€  `buildRunStepValidationPrompt` å¹¶è°ƒç”¨ `callAnyAvailableAgent`ï¼š
     - è‹¥ `success: true`ï¼š
       - è¾“å‡º `âœ“ verification éªŒè¯é€šè¿‡`ï¼›
       - è®°å½•æœ¬è½®é€šè¿‡ä¿¡æ¯ï¼Œé‡å†™ `run-progress.md`ï¼›
       - æ§åˆ¶å°é¢å¤–æ‰“å°ï¼š`âœ“ ç¬¬ N æ¬¡å°è¯•åæ­¥éª¤å·²é€šè¿‡æ‰€æœ‰æµ‹è¯•ä¸éªŒè¯`ï¼›
       - è·³å‡ºå½“å‰æ­¥éª¤çš„å¤šè½®å¾ªç¯ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªæ­¥éª¤ã€‚
     - è‹¥ `success: false`ï¼š
       - è¾“å‡º `âœ— verification éªŒè¯æœªé€šè¿‡ï¼š<é”™è¯¯>`ï¼›
       - å°†çŠ¶æ€æ”¹å› `ğŸ”´ å¾…å®Œæˆ`ï¼Œè®°å½• `verificationError`ï¼›
       - æ›´æ–°ä¸Šä¸€è½®å¤±è´¥ä¸Šä¸‹æ–‡ï¼ˆç”¨äºä¸‹ä¸€è½® promptï¼‰ï¼›
       - å†™å› JSONï¼Œé‡å†™ `run-progress.md`ï¼›
       - è‹¥ `attempt < MAX_ATTEMPTS`ï¼šè¿›å…¥ä¸‹ä¸€è½®å°è¯•ï¼›
       - è‹¥ `attempt === MAX_ATTEMPTS`ï¼šè®°å½• `firstFailure`ï¼Œç»ˆæ­¢æœ¬æ¬¡ `run`ã€‚

åœ¨ `--full-verify` æ¨¡å¼ä¸‹ï¼Œå¯¹äºé‡æ–°æ‰“å¼€éœ€è¦å®ç°çš„æ­¥éª¤ï¼Œå¤šè½®å®ç°ä»ç„¶å­˜åœ¨ï¼Œä½†æœ¬è½®å®ç°ä¹‹åä¸ä¼šå†è‡ªåŠ¨æ‰§è¡Œå•å…ƒæµ‹è¯•ä¸ verificationï¼ˆå³è·³è¿‡ä¸Šè¿°æ­¥éª¤ 1 å’Œ 2ï¼‰ï¼Œä»…ä¾èµ–å®ç°é˜¶æ®µçš„æˆåŠŸä¸å¦æ¥åˆ¤å®šæ˜¯å¦éœ€è¦é‡è¯•ã€‚

### 5.6 ç»ˆæ­¢æ¡ä»¶ä¸è¾¹ç•Œæƒ…å†µ

å•ä¸ªæ­¥éª¤çš„å¤šè½®è‡ªåŠ¨ä¿®å¤åœ¨ä»¥ä¸‹æƒ…å†µç»“æŸï¼š

- **æˆåŠŸç»“æŸ**ï¼š
  - æŸä¸€è½®å®ç°æˆåŠŸï¼Œä¸”åœ¨æ™®é€šæ¨¡å¼ä¸‹é€šè¿‡äº†æœ¬è½®å•å…ƒæµ‹è¯•ä¸ verificationï¼ˆæˆ–åœ¨ full-verify æ¨¡å¼ä¸‹å®ç°æˆåŠŸï¼Œæ— éœ€é¢å¤–éªŒè¯ï¼‰ï¼›
  - æœ€ç»ˆçŠ¶æ€ä¸º `ğŸŸ¢ å·²å®Œæˆ`ï¼Œ`run-progress.md` ä¸­è¯¥æ­¥éª¤çš„ã€Œæ‰§è¡ŒåçŠ¶æ€ã€ä¸º `ğŸŸ¢ å·²å®Œæˆ`ï¼Œç»“æœåˆ—ä¸º `æˆåŠŸ`ï¼Œé”™è¯¯ä¿¡æ¯ä¸ºç©ºã€‚
- **å¤±è´¥ç»“æŸ**ï¼ˆè¾¾åˆ°ä¸Šé™ï¼‰ï¼š
  - åœ¨å®ç°é˜¶æ®µã€å•å…ƒæµ‹è¯•é˜¶æ®µæˆ– verification é˜¶æ®µè¿ç»­å¤±è´¥ **5 è½®**ï¼ˆ`MAX_ATTEMPTS`ï¼‰ï¼Œä¸”æ¯ä¸€è½®å¤±è´¥ä¹‹åéƒ½å·²å°è¯•è‡ªåŠ¨ä¿®å¤ï¼›
  - åˆ°è¾¾ç¬¬ 5 è½®å¤±è´¥æ—¶ï¼š
    - å½“å‰æ­¥éª¤çš„çŠ¶æ€è¢«å†™å›ä¸º `ğŸ”´ å¾…å®Œæˆ`ï¼›
    - `entry.success = false`ï¼Œå¹¶è®°å½•æœ€åä¸€æ¬¡å¤±è´¥åŸå› ï¼›
    - é€šè¿‡ `firstFailure` è®°å½•ç¬¬ä¸€ä¸ªå¤±è´¥æ­¥éª¤ï¼›
    - æ§åˆ¶å°æ±‡æ€»è¾“å‡ºã€Œæœ¬è½®å¤±è´¥æ‘˜è¦ã€ä»¥åŠæœ€ç»ˆçš„å¤±è´¥æ­¥éª¤ä¿¡æ¯ï¼›
    - `run-progress.md` ä¸­è¯¥æ­¥éª¤çš„ã€Œæ‰§è¡ŒåçŠ¶æ€ã€ä¸º `ğŸ”´ å¾…å®Œæˆ`ï¼Œç»“æœåˆ—ä¸º `å¤±è´¥`ï¼Œé”™è¯¯ä¿¡æ¯åŒ…å«æœ€åä¸€æ¬¡å¤±è´¥æ‘˜è¦ã€‚

ä¸€æ—¦æŸä¸ªæ­¥éª¤åœ¨ç¬¬ 5 è½®ä»æœªä¿®å¤æˆåŠŸï¼Œæœ¬æ¬¡ `run` å°†ä¸å†å°è¯•åç»­æ­¥éª¤ï¼Œç›´æ¥ç»“æŸå¹¶è¿”å›éé›¶é€€å‡ºç ã€‚

## 6. è¿›åº¦æŠ¥å‘Šä¸ç”¨æˆ·ä½“éªŒ

- `run-progress.md`ï¼š
  - æ–‡ä»¶åå›ºå®šä¸º `run-progress.md`ï¼Œä½äºæ­¥éª¤ç›®å½•ï¼›
  - åœ¨ä»¥ä¸‹æ—¶æœºé‡å†™ï¼š
    - è§£æ JSON å¤±è´¥æ—¶ï¼ˆå¼€å¤´å°±ç»ˆæ­¢ï¼‰ï¼›
    - æ¯è½®å®ç°é˜¶æ®µå‡ºç°å†™å…¥é”™è¯¯ï¼›
    - æ¯è½®å•å…ƒæµ‹è¯•å¤±è´¥ï¼›
    - æ¯è½® verification å¤±è´¥ï¼›
    - æ¯è½®éªŒè¯æˆåŠŸåï¼ˆåŒ…æ‹¬ full-verify åœºæ™¯ï¼‰ã€‚
- æ§åˆ¶å°ï¼š
  - æ¯ä¸ªæ­¥éª¤çš„æ¯ä¸€è½®å°è¯•éƒ½ä¼šæ‰“å°ï¼š
    - å½“å‰è½®æ¬¡ï¼ˆè®¡åˆ’å®ç°åï¼‰ï¼›
    - çŠ¶æ€å˜æ›´ï¼ˆğŸ”´/ğŸŸ¡/ğŸŸ¢ï¼‰ï¼›
    - å•æµ‹å‘½ä»¤ä¸ç»“æœï¼›
    - verification éªŒè¯ç»“æœï¼›
    - å½“æ¬¡ run çš„æ±‡æ€»ç»Ÿè®¡ã€‚
