# `analyze` 命令需求说明

本文档描述在 `agent-foreman` 项目中新增 `analyze` 命令的功能需求和行为约束。

## 1. 命令形式与输入

- 新增 CLI 命令：`agent-foreman analyze <spec-path>`  
  - `<spec-path>` 为任意文本需求文档路径（可以是 Markdown 或普通文本）。
- 命令读取 `<spec-path>` 指向文件的内容，并结合**当前项目代码**（执行目录下的源码、测试、配置等），用作后续 AI 分析的输入。

## 2. 需求名字与输出目录

- `analyze` 需要调用命令行 AI（通过已有的 agent 管理机制）**第一次**，根据需求文档内容自动生成一个「需求名字」字符串。
- 使用生成的需求名字构造输出目录名，格式为：
  - `<需求名字>需求实现步骤`
  - 例如 AI 生成「用户登录」作为需求名字，则目录名为：`用户登录需求实现步骤`。
- 输出目录创建规则：
  - 目录创建位置：当前工作目录（执行命令的目录）。
  - 如果目标目录已经存在，则：
    - 直接报错并中止本次命令；
    - 不生成任何 JSON 文件；
    - 不修改已有目录中的内容。

## 3. 实现单元与 AI 拆分

- 在目录名生成之后，`analyze` 需要再次调用命令行 AI（第二次调用），根据**完整需求文档内容**以及**当前项目代码**将需求拆分为一组按顺序排列的「最小实现单元」。
- 每个「最小实现单元」包含：
  - 该实现单元的详细说明（用于执行时的实现指导）；
  - 对应的验证方式列表（用于后续自动生成测试）；
  - 文件名用的唯一 slug（例如：`setup-auth-api`）。
- 在一次 `analyze` 调用中：
  - 所有实现单元的 slug 必须互不重复；
  - 实现层会对 slug 做轻量清洗（去除非法文件名字符等），并检测重复；
  - 如检测到重复 slug，应视为错误并中止或提示（具体错误处理在实现阶段细化）。

## 4. JSON 文件与命名规则

- `analyze` 会在 `<需求名字>需求实现步骤` 目录下，为每个实现单元生成一个独立的 JSON 文件。
- JSON 文件命名规则：
  - 采用顺序号 + slug 的形式：`NNN-<slug>.json`
  - 其中：
    - `NNN` 为三位数字顺序号，从 `001` 开始递增（`001`、`002`、`003`……）；
    - `<slug>` 为该实现单元的文件名片段，由 AI 决定。
- 排序约定：
  - 按文件名排序（字典序）即为实现单元的实际执行顺序。

## 5. JSON 文件结构

每个实现单元对应的 JSON 文件至少包含以下字段：

- `id`: 字符串形式的步骤标识
  - 例如：`"step-001"`、`"step-002"`；
  - 与文件名中的顺序号一致，并在同一目录内唯一。
- `description`: 当前实现单元的详细说明
  - 用于指导 foreman/AI 在执行该单元时，需要完成哪些具体工作；
  - 中文描述为主，必要时可夹带英文技术术语。
- `status`: 当前实现单元的完成状态
  - 为一个字符串，仅允许以下三种取值之一：
    - `"🔴 待完成"`
    - `"🟡 进行中"`
    - `"🟢 已完成"`
  - `analyze` 命令在初次生成 JSON 时，会结合**现有项目代码**对每个步骤单独判断：
    - 若 AI 判断当前代码已经基本实现该步骤，则可以直接将 `status` 设为 `"🟢 已完成"`；
    - 若仍需实现或无法确定是否完成，则将 `status` 设为 `"🔴 待完成"`（保守策略）；
    - `"🟡 进行中"` 仅由后续的 `run` 命令在执行过程中作为临时状态使用，`analyze` 不会生成 `"🟡"` 作为初始状态。
- `verification`: 验证方式列表（对象数组）
  - 用于记录当前实现单元的所有测试项目，后续执行该单元时，用于驱动自动测试/验证。
  - 数组元素结构示例：
    ```json
    {
      "type": "unit",
      "description": "为登录接口编写单元测试，覆盖正确密码和错误密码"
    }
    ```
  - 字段含义：
    - `type`: 测试类型，如：
      - `"unit"`（单元测试）
      - `"integration"`（集成测试）
      - `"ui"`（UI 自动化测试）
      - `"manual"`（人工验证）
      - 以及其他将来可能扩展的类型；
      - 当前阶段不强制限定枚举，只要是有意义的字符串即可。
    - `description`: 对该验证项目的具体说明，用于后续生成测试代码或自动化脚本。

> 备注：未来如有需要，可在 JSON 中扩展其他字段（如 `dependencies`、`owner`、`estimate` 等），但本版需求不做强制要求。

## 6. 与现有 AI 元数据的关系

- 本功能与以下文件完全独立：
  - `ai/feature_list.json`
  - `ai/progress.log`
- `analyze` 命令：
  - 不依赖上述文件存在；
  - 不读写上述文件；
  - 仅读写 `<需求名字>需求实现步骤` 目录下的 JSON 步骤文件。

## 7. 总结

综上，`analyze` 命令的职责是：

- 基于任意文本需求文档：
  - 调用 AI 自动生成「需求名字」；
  - 基于该名字创建 `<需求名字>需求实现步骤` 目录（若已存在则报错中止）；
  - 再次调用 AI，将整体需求拆分为若干按顺序排列的「最小实现单元」；
  - 为每个实现单元生成一个结构统一的 JSON 文件，文件名形如 `NNN-<slug>.json`，JSON 中包含 `id`、`description`、`status`、`verification` 等字段。
